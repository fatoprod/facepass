rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ==========================================
    // FUNÇÕES AUXILIARES DE AUTENTICAÇÃO
    // ==========================================
    
    // Verifica se o usuário está autenticado
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Obtém os dados do usuário autenticado
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }
    
    // Verifica se o usuário tem uma role específica
    function hasRole(role) {
      return isAuthenticated() && getUserData().role == role;
    }
    
    // Verifica se o usuário é admin
    function isAdmin() {
      return hasRole('ADMIN');
    }
    
    // Verifica se o usuário é gerente ou superior
    function isManagerOrHigher() {
      let userRole = getUserData().role;
      return isAuthenticated() && (userRole == 'ADMIN' || userRole == 'MANAGER');
    }
    
    // Verifica se o usuário é operador ou superior
    function isOperatorOrHigher() {
      let userRole = getUserData().role;
      return isAuthenticated() && (userRole == 'ADMIN' || userRole == 'MANAGER' || userRole == 'OPERATOR');
    }
    
    // Verifica se o usuário está ativo
    function isActiveUser() {
      return isAuthenticated() && getUserData().isActive == true;
    }
    
    // ==========================================
    // COLEÇÃO DE USUÁRIOS
    // ==========================================
    match /users/{userId} {
      // Usuário pode ler seus próprios dados
      allow read: if isAuthenticated() && (request.auth.uid == userId || isAdmin());
      
      // Criar próprio perfil (no registro) - apenas role USER
      allow create: if isAuthenticated() && request.auth.uid == userId 
        && request.resource.data.role == 'USER'
        && request.resource.data.isActive == true;
      
      // Usuário pode atualizar seus próprios dados (exceto role e isActive)
      allow update: if isAuthenticated() && request.auth.uid == userId
        && request.resource.data.role == resource.data.role
        && request.resource.data.isActive == resource.data.isActive;
      
      // Apenas admin pode atualizar role e status de outros usuários
      allow update: if isAdmin() && request.auth.uid != userId;
      
      // Apenas admin pode deletar usuários
      allow delete: if isAdmin();
    }
    
    // Lista de todos os usuários (apenas admin)
    match /users/{document=**} {
      allow list: if isAdmin();
    }
    
    // ==========================================
    // COLEÇÃO DE EVENTOS
    // ==========================================
    match /events/{eventId} {
      // Qualquer um pode ler eventos ativos
      allow read: if true;
      
      // Apenas gerentes e admins podem criar eventos
      allow create: if isManagerOrHigher() && isActiveUser() && isValidEvent(request.resource.data);
      
      // Gerentes e admins podem atualizar qualquer campo
      // Qualquer pessoa pode incrementar currentAttendees (ao comprar ingresso)
      allow update: if (isManagerOrHigher() && isActiveUser())
        || isValidAttendeeIncrement(request.resource.data, resource.data);
      
      // Apenas admins podem deletar eventos
      allow delete: if isAdmin() && isActiveUser();
    }
    
    // ==========================================
    // COLEÇÃO DE TICKETS
    // ==========================================
    match /tickets/{ticketId} {
      // Leitura: Operadores+ podem ler todos, ou usuário autenticado vê seus próprios
      // Para catraca (scanner de rosto), permitir leitura pública
      allow read: if true;
      
      // Qualquer pessoa pode comprar/cadastrar tickets (para eventos gratuitos)
      // Validação de estrutura é feita pela função isValidTicket
      allow create: if isValidTicket(request.resource.data);
      
      // Operadores podem atualizar status (para marcar como usado na catraca)
      // Gerentes e admins têm acesso total
      // Para catraca funcionar sem auth, permitir update de status
      allow update: if isValidStatusUpdate(request.resource.data, resource.data);
      
      // Apenas admins podem deletar tickets
      allow delete: if isAdmin() && isActiveUser();
    }
    
    // ==========================================
    // LOGS DE ACESSO (AUDITORIA)
    // ==========================================
    match /accessLogs/{logId} {
      // Apenas admins e gerentes podem ler logs
      allow read: if isManagerOrHigher() && isActiveUser();
      
      // Qualquer sistema pode criar logs (registro de entrada na catraca)
      allow create: if true;
      
      // Ninguém pode atualizar ou deletar logs
      allow update, delete: if false;
    }
    
    // ==========================================
    // FUNÇÕES DE VALIDAÇÃO
    // ==========================================
    
    // Função para validar estrutura do evento
    function isValidEvent(data) {
      return data.keys().hasAll(['name', 'date', 'location', 'isFree', 'price', 'maxCapacity', 'isActive'])
        && data.name is string
        && data.name.size() > 0
        && data.price is number
        && data.price >= 0
        && data.maxCapacity is number
        && data.maxCapacity > 0;
    }
    
    // Função para validar incremento de participantes (apenas +1)
    function isValidAttendeeIncrement(newData, existingData) {
      return newData.currentAttendees == existingData.currentAttendees + 1
        && newData.name == existingData.name
        && newData.date == existingData.date
        && newData.location == existingData.location
        && newData.isFree == existingData.isFree
        && newData.price == existingData.price
        && newData.maxCapacity == existingData.maxCapacity
        && newData.isActive == existingData.isActive;
    }
    
    // Função para validar estrutura do ticket
    function isValidTicket(data) {
      return data.keys().hasAll(['eventId', 'userId', 'user', 'type', 'price', 'status', 'purchaseDate'])
        && data.user.keys().hasAll(['id', 'name', 'email', 'cpf'])
        && data.type in ['GRATUITO', 'PADRAO', 'VIP', 'BACKSTAGE']
        && data.status in ['AGUARDANDO_PAGAMENTO', 'PAGO_AGUARDANDO_ROSTO', 'ATIVO', 'UTILIZADO', 'EXPIRADO']
        && data.price is number
        && data.price >= 0;
    }
    
    // Função para validar atualização de status
    function isValidStatusUpdate(newData, existingData) {
      return newData.status in ['AGUARDANDO_PAGAMENTO', 'PAGO_AGUARDANDO_ROSTO', 'ATIVO', 'UTILIZADO', 'EXPIRADO']
        && newData.userId == existingData.userId
        && newData.user == existingData.user
        && newData.type == existingData.type
        && newData.price == existingData.price;
    }
  }
}

